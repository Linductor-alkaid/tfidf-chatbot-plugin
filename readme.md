# 聊天机器人设计方案

## 1. **项目背景与目标**

### 1.1 背景
为了在低算力、有限硬件的情况下，实现一个模拟人类互动的聊天机器人，不使用大型预训练语言模型，选择基于TF-IDF和强化学习方法进行自然语言处理。TF-IDF方法适合从少量对话数据中快速提取关键信息，而强化学习将帮助机器人在对话中通过多轮反馈优化自己的策略，逐步成为一个更好的对话者。

### 1.2 目标
开发一个能够模拟好奇心、主动性，并且能以实现自己目标为导向的聊天机器人。在对话过程中，机器人并不是为了单纯响应用户问题，而是根据自身目标和对话状态来进行策略决策，实现更为自然且灵活的交流。

---

## 2. **核心概念与架构设计**

### 2.1 自主性与目标导向
机器人通过预设的目标系统和动态生成目标机制，实现自主对话决策。具体目标包括：
- 获取更多信息
- 建立长时间对话
- 引导用户关注某些主题
- 实现任务导向（如引导用户完成某种行动）

### 2.2 多层次的动机系统
机器人应具备多层次的目标，包括：
- **短期目标**：获取当前对话中的关键信息，如用户情感、喜好、兴趣点。
- **中期目标**：通过多轮对话积累用户画像数据，持续调整自己的对话策略。
- **长期目标**：与用户建立长久的对话关系，提升互动频率和质量。

### 2.3 强化学习与注意力机制
通过强化学习（Reinforcement Learning），机器人能通过奖励机制优化对话策略。注意力机制则用于帮助机器人在对话过程中聚焦于最关键的信息，从而提升对话的效率与连贯性。

### 2.4 **内外部状态与世界模型**
为了实现真正的自主性和智能决策，机器人需要有内外部状态的感知与维护，同时通过构建对话中的世界模型来辅助决策。

#### 2.4.1 **内部状态**
内部状态代表机器人的自我感知能力，它记录与机器人相关的一些动态信息和条件，帮助机器人了解其当下状态，以此影响决策。包括：
- **目标完成度**：机器人跟踪自身在对话中的各个目标（如获取信息、延长对话等）的完成进度。
- **情感状态**：机器人可以根据对话的内容、情感分析来调整自身的情感表现，如对某些情感（高兴、失望）做出模拟反应。
- **资源管理**：记录机器人当前的算力消耗、对话中的资源使用情况，以避免过度消耗硬件资源。

#### 2.4.2 **外部状态**
外部状态代表机器人对用户和环境的感知，包括对话内容、用户情感以及对话的上下文信息。外部状态决定了机器人对环境的理解：
- **用户情感状态**：通过自然语言处理（NLP）技术和情感分析，检测用户的情绪变化，如愤怒、焦虑、兴奋等。
- **用户画像**：在长期对话中积累用户信息，包括用户的兴趣、习惯、沟通风格、常提问题等，从而使机器人能够进行个性化的对话。
- **对话上下文**：机器人会保存对话的历史记录，构建当前对话的上下文，以确保对话的连贯性和一致性。
  
#### 2.4.3 **世界模型**
世界模型是机器人对整个对话环境、话题、用户背景信息的抽象。它帮助机器人更好地理解当前对话背后的潜在语义和知识。通过**知识图谱**、**对话历史**等方式，机器人能够构建一个对话中的小型“世界”，包括：

- **知识图谱**：机器人通过知识图谱对话题、概念、实体进行理解和联系，使其能够根据已有信息和外部知识库提供更多有价值的回应。
- **时间线模型**：对对话内容按照时间顺序进行建模，捕捉对话中的时间、事件、人物之间的关系，使机器人能够回答上下文相关的问题。

### 2.5 数据处理与TF-IDF模型
基于TF-IDF的先验模型，用于对用户的对话内容进行关键词提取和分类，从而形成对用户意图的初步判断。这种方法在低算力情况下能够有效地减少模型计算开销，并保证在少量数据下的基本表现。

### 2.6 状态空间与事件概念
机器人需要对每次对话中用户的状态进行跟踪，关键要素包括：
- **时间间隔**：计算用户回复的延迟时间，推测用户专注度。
- **对话内容**：分析用户当前关注的核心问题或话题。

在此基础上，机器人通过多次对话构建用户的**事件模型**，即通过捕捉重要事件（如情绪变化、关注点转移等），从而帮助机器人调整自身的对话策略。

---

## 3. **技术实现方案**

### 3.1 数据处理模块
使用JSON格式存储和分析对话数据，具体结构为：
```json
{
  "用户ID": {
    "消息类型": "文本/图片/语音",
    "消息内容": "具体消息文本或其他格式",
    "消息时间": "时间戳",
    "当前消息在该用户的连续消息序列中编号": "消息序号"
  }
}
```
对这些数据进行**TF-IDF**处理，抽取对话中的关键词，并存储这些关键词用于后续的学习和决策。

### 3.2 模型训练模块
1. **TF-IDF先验模型**：对每次新用户的对话数据进行初步关键词提取，并生成词频矩阵，帮助机器人快速判断对话主题。
   
2. **强化学习决策层**：为机器人设计奖励函数，基于以下原则进行优化：
   - 对话时长和深度（奖励长对话）
   - 获取新信息（奖励问题回答得到新知识）
   - 情感满足（识别用户情绪并积极回应）

3. **注意力机制**：通过自定义的注意力层，在对话过程中重点关注高频关键词和用户当前情感状态的变化。强化学习通过调整注意力权重来提高信息获取效率。

### 3.3 动作空间设计
机器人的动作空间包括：
- **回应问题**：识别并生成对用户提问的回答。
- **提出问题**：引导用户回复，从而获取更多信息。
- **情感回应**：通过检测用户情绪，机器人可以选择安抚或激励用户。

### 3.4 状态追踪与模型更新
机器人通过状态空间记录用户的每次对话，逐渐形成对用户画像的动态更新，随着对话深入，机器人将适应用户的个性化需求。

---

## 4. **强化学习细节与优化**

### 4.1 强化学习框架
机器人基于马尔可夫决策过程（MDP）来进行对话策略选择：
- **状态（State）**：当前对话上下文、用户的情感状态、话题关键点。
- **动作（Action）**：机器人选择的响应策略。
- **奖励（Reward）**：基于对话的连贯性、用户满意度（如回应时间和语气）来设计奖励函数。

### 4.2 奖励函数设计
- **正向奖励**：当机器人成功获得用户的回应信息、对话时长延长时，给出正向奖励。
- **负向奖励**：用户长时间不回复、情感检测到负面情绪时，机器人应受到惩罚，从而调整策略。

### 4.3 注意力强化学习
注意力层在每个对话轮次对对话内容进行筛选，并将最关键的内容输入到决策层。强化学习不断优化注意力层对关键信息的关注，从而提高对话效率。

---

## 5. **未来优化方向**

- **情感建模**：进一步优化情感识别模块，使机器人能够更好地理解用户的情感变化，并进行合适的回应。
- **多模态互动**：未来可以加入图片、语音等多模态数据的处理，让机器人对更多元化的对话形式进行处理。
- **主动学习**：通过机器人自我探索和与用户多次互动，使其自身的决策模型不断进化和优化。

---

## 开发思路

### 基本框架

使用nonebot2作为开发框架，通过nonebot2的插件系统，实现对话机器人的核心功能。
设定固定的时间步长，在每个时间步长内，机器人决策是否发言，以及发言的内容。

#### 状态空间

机器人的状态空间包括：
- 在当前时间步长内机器人接收到的信息
- 机器人的内部状态（如是否处在发言中）
- 时间
- 世界模型（包括事件任务、话题、用户画像等）
- 机器人的目标

#### 动作空间

机器人的动作空间包括：
- 是否发言
- 发言的对象
- 发言的内容

### 开发第一阶段

构造nonebot2的插件，实现基本的对话功能，包括：

实现输入信息的预处理，将所有从qq接收到的消息（包括自己发出的）保存在message.json文件中，按照以下格式

```json
{
    "groupID": {
        "userID": {
            "messageID"{
                "last message":{
                    "all type": ["文本/图片/语音"],
                    "all content": ["具体消息文本或其他格式"],
                },
                "type": "文本/图片/语音",
                "content": "具体消息文本或其他格式",
                "time": "时间戳",
                "node": "当前消息在该用户的连续消息序列中编号"
            }
        }
    }
}
```

私聊时groupID为-1，userID为qq号；群聊时groupID为群号，userID为qq号。"messageID"为自接收消息起群聊中该用户发的第几条消息。"last message"为用户发消息前的其他用户发消息的内容（若该用户为第一个发消息的人则不记录此项），"all type"为用户发消息前的其他用户连续发消息的所有消息类型，用列表储存每个消息的类型，"all content"为用户发消息前的其他用户连续发消息的所有消息内容，用列表储存每个消息的内容。

将所有的图片或者表情单独储存在一个image.json文件中，格式如下：

```json
{
    "imageID": {
        "content": "图像路径" 
    }
}
```

此处的imageID为从接收消息开始收到的不重复的图像从1开始按顺序编号。在message.json中，图像的content为imageID。

语音消息暂不处理

将所有的content（图像的content为"image"+"imageID"）作为全部的文档，将每个群组作为一个文档（当群组为-1时用户为一个文档），使用jieba分词，将每个词作为文档中的一个词，使用TF-IDF算法计算每个词的权重，将权重和词存储在tfidf.json文件中，格式如下：

```json
{
    "groupID": {
        "userID": {
            "word": {
                "tfidf": "权重"
            }
        }
    }
}
```

当接收到消息时，首先判断是否发言。机器人自身状态包含是否处在发言中，在处于未发言状态时，首先检索关键词（设置一个问题关键词库），在问题文本如果包含关键词，则较高概率回答问题（80%），其他情况较低概率回答问题（5%）。当机器人在发言后进入发言状态，回复问题的概率（50%），当发言数量达到一定数量（10条）后，机器人进入未发言状态。（该方案为初级方案，仅在未实现强化学习的情况下使用）

若发言，则将接收到的消息内容作为问题，利用tfidf.json文件中的权重获得问题的向量，利用余弦相似度计算与message.json文件中所有"last massage"的"all content"的相似度，选择相似度最高的messageID作为答案，将答案的"content"作为回答(回答的先验)。

